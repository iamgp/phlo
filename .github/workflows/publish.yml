name: Publish to PyPI

on:
  release:
    types: [published]
  workflow_dispatch:
    inputs:
      dry_run:
        description: "Build packages but skip publishing to PyPI"
        required: false
        default: "false"
      base_ref:
        description: "Git ref to compare against for change detection (defaults to previous tag)"
        required: false
        default: ""

permissions:
  contents: read # Required to checkout private repo
  id-token: write # Required for trusted publishing

jobs:
  plan:
    runs-on: ubuntu-latest
    outputs:
      packages: ${{ steps.plan.outputs.packages }}
      has_packages: ${{ steps.plan.outputs.has_packages }}
      dry_run: ${{ steps.plan.outputs.dry_run }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Determine packages to publish
        id: plan
        env:
          BASE_REF: ${{ github.event_name == 'workflow_dispatch' && inputs.base_ref || '' }}
          DRY_RUN: ${{ github.event_name == 'workflow_dispatch' && inputs.dry_run || 'false' }}
        run: python .github/scripts/publish_plan.py

      - name: Log publish plan
        run: |
          echo "Dry run: ${{ steps.plan.outputs.dry_run }}"
          echo "Packages: ${{ steps.plan.outputs.packages }}"

  build:
    needs: plan
    if: needs.plan.outputs.has_packages == 'true'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install uv
        uses: astral-sh/setup-uv@v7
        with:
          version: "latest"

      - name: Set up Python
        run: uv python install 3.11

      - name: Build packages
        run: |
          rm -rf dist
          mkdir -p dist
          echo '${{ needs.plan.outputs.packages }}' > /tmp/packages.json
          python - <<'PY'
          import json
          import pathlib
          import subprocess

          packages = json.loads(pathlib.Path("/tmp/packages.json").read_text(encoding="utf-8"))
          if not packages:
              raise SystemExit("No packages selected for build.")
          for package in packages:
              subprocess.check_call(["uv", "build", "--package", package, "--out-dir", "dist"])
          PY

      - name: Upload artifacts
        uses: actions/upload-artifact@v6
        with:
          name: dist
          path: dist/

  publish:
    needs: [plan, build]
    if: needs.plan.outputs.has_packages == 'true' && needs.plan.outputs.dry_run != 'true'
    runs-on: ubuntu-latest
    environment: pypi # Configure this in GitHub repo settings
    steps:
      - name: Download artifacts
        uses: actions/download-artifact@v7
        with:
          name: dist
          path: dist/

      - name: Publish to PyPI
        uses: pypa/gh-action-pypi-publish@release/v1
        with:
          packages-dir: dist
        # Uses trusted publishing - configure at pypi.org/manage/project/phlo/settings/publishing/
