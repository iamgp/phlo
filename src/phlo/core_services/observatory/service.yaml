name: observatory
description: Phlo Observatory - Data platform visibility and lineage UI
category: core
default: true
core: true

# Production: use published Docker image
image: ghcr.io/iamgp/phlo-observatory:latest

# Source path for dev builds (relative to phlo package root)
source_path: packages/phlo-observatory/src/phlo_observatory

depends_on:
  - phlo-api

compose:
  restart: unless-stopped
  environment:
    NODE_ENV: production
    HOST: 0.0.0.0
    PORT: 3000
    DAGSTER_GRAPHQL_URL: http://dagster:3000/graphql
    NESSIE_URL: http://nessie:19120/api/v2
    TRINO_URL: http://trino:8080
    PHLO_API_URL: http://phlo-api:4000
  ports:
    - "${OBSERVATORY_PORT:-3001}:3000"
  healthcheck:
    test:
      [
        "CMD",
        "wget",
        "--no-verbose",
        "--tries=1",
        "--spider",
        "http://127.0.0.1:3000/",
      ]
    interval: 30s
    timeout: 10s
    retries: 3
    start_period: 30s

env_vars:
  OBSERVATORY_PORT:
    default: 3001
    description: Observatory UI port

# Dev mode: run as subprocess (no Docker)
dev:
  command:
    [
      "npm",
      "run",
      "dev",
      "--",
      "--host",
      "0.0.0.0",
      "--port",
      "${OBSERVATORY_PORT:-3001}",
    ]
  environment:
    NODE_ENV: development
    PHLO_API_URL: http://localhost:4000
    DAGSTER_GRAPHQL_URL: http://localhost:3000/graphql
    NESSIE_URL: http://localhost:19120/api/v2
    TRINO_URL: http://localhost:8080
  health_check: "http://127.0.0.1:${OBSERVATORY_PORT:-3001}/"
  cwd: "{source_path}"
  requires_build: true
  build_if_missing: "node_modules/.bin/vite"
  build_command: ["npm", "ci"]
