services:
  postgres:
    image: postgres:16
    container_name: pg
    restart: unless-stopped
    environment:
      POSTGRES_USER: ${POSTGRES_USER}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
      POSTGRES_DB: ${POSTGRES_DB}
    ports: ["${POSTGRES_PORT}:5432"]
    volumes:
      - ./volumes/postgres:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER}"]
      interval: 10s
      timeout: 5s
      retries: 10

  minio:
    image: minio/minio:latest # <-- CHANGED: use a valid tag
    container_name: minio
    restart: unless-stopped
    environment:
      MINIO_ROOT_USER: ${MINIO_ROOT_USER}
      MINIO_ROOT_PASSWORD: ${MINIO_ROOT_PASSWORD}
    command: server --console-address ":${MINIO_CONSOLE_PORT}" /data
    ports:
      - "${MINIO_API_PORT}:9000"
      - "${MINIO_CONSOLE_PORT}:${MINIO_CONSOLE_PORT}"
    volumes:
      - ./volumes/minio:/data
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:9000/minio/health/ready"]
      interval: 10s
      timeout: 5s
      retries: 10

  dagster-webserver:
    build:
      context: ./dagster
    container_name: dagster-web
    restart: unless-stopped
    environment:
      DAGSTER_HOME: /opt/dagster
      DBT_PROFILES_DIR: /dbt/profiles
      AWS_ACCESS_KEY_ID: ${MINIO_ROOT_USER}
      AWS_SECRET_ACCESS_KEY: ${MINIO_ROOT_PASSWORD}
      AWS_REGION: eu-west-1
      AWS_S3_ENDPOINT: http://minio:9000
    command:
      [
        "dagster-webserver",
        "-h",
        "0.0.0.0",
        "-p",
        "3000",
        "-w",
        "/opt/dagster/workspace.yaml",
      ]
    ports: ["${DAGSTER_PORT}:3000"]
    volumes:
      - ./dagster:/opt/dagster
      - ./lakehousekit:/opt/dagster/lakehousekit
      - ./dbt:/dbt
      - ./data:/data
      - ./great_expectations:/great_expectations
    depends_on:
      minio:
        condition: service_healthy
      postgres:
        condition: service_healthy

  dagster-daemon:
    build:
      context: ./dagster
    container_name: dagster-daemon
    restart: unless-stopped
    environment:
      DAGSTER_HOME: /opt/dagster
      DBT_PROFILES_DIR: /dbt/profiles
      AWS_ACCESS_KEY_ID: ${MINIO_ROOT_USER}
      AWS_SECRET_ACCESS_KEY: ${MINIO_ROOT_PASSWORD}
      AWS_REGION: eu-west-1
      AWS_S3_ENDPOINT: http://minio:9000
    command: ["dagster-daemon", "run"]
    volumes:
      - ./dagster:/opt/dagster
      - ./lakehousekit:/opt/dagster/lakehousekit
      - ./dbt:/dbt
      - ./data:/data
      - ./great_expectations:/great_expectations
    depends_on:
      dagster-webserver:
        condition: service_started

  superset:
    build:
      context: ./infra
      dockerfile: Dockerfile.superset
    container_name: superset
    restart: unless-stopped
    command: ["/bin/sh", "-c", "/app/docker/docker-init.sh && /usr/bin/run-server.sh"]
    environment:
      SUPERSET_SECRET_KEY: superset_secret_key_change_me
      SUPERSET_CONFIG_PATH: /app/pythonpath/superset_config.py
      POSTGRES_USER: ${POSTGRES_USER}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
      POSTGRES_DB: ${POSTGRES_DB}
      SUPERSET_ADMIN_USER: ${SUPERSET_ADMIN_USER:-admin}
      SUPERSET_ADMIN_PASSWORD: ${SUPERSET_ADMIN_PASSWORD:-admin123}
      SUPERSET_ADMIN_EMAIL: ${SUPERSET_ADMIN_EMAIL:-admin@example.com}
    volumes:
      - ./volumes/superset:/app/superset_home
      - ./infra/superset_config.py:/app/pythonpath/superset_config.py
    ports: ["${SUPERSET_PORT}:8088"]
    depends_on:
      postgres:
        condition: service_healthy

  datahub-gms:
    image: acryldata/datahub-gms:head
    container_name: datahub-gms
    restart: unless-stopped
    environment:
      ALTERNATE_MCP_VALIDATION: "true"
      DATAHUB_BASE_PATH: /
      DATAHUB_GMS_BASE_PATH: /
      DATAHUB_SERVER_TYPE: quickstart
      DATAHUB_TELEMETRY_ENABLED: "false"
      DATAHUB_UPGRADE_HISTORY_KAFKA_CONSUMER_GROUP_ID: generic-duhe-consumer-job-client-gms
      EBEAN_DATASOURCE_DRIVER: com.mysql.jdbc.Driver
      EBEAN_DATASOURCE_HOST: datahub-mysql:3306
      EBEAN_DATASOURCE_PASSWORD: datahub
      EBEAN_DATASOURCE_URL: jdbc:mysql://datahub-mysql:3306/datahub?verifyServerCertificate=false&useSSL=true&useUnicode=yes&characterEncoding=UTF-8&enabledTLSProtocols=TLSv1.2
      EBEAN_DATASOURCE_USERNAME: datahub
      ELASTICSEARCH_HOST: datahub-opensearch
      ELASTICSEARCH_IMPLEMENTATION: opensearch
      ELASTICSEARCH_INDEX_BUILDER_MAPPINGS_REINDEX: "true"
      ELASTICSEARCH_INDEX_BUILDER_SETTINGS_REINDEX: "true"
      ELASTICSEARCH_LIMIT_RESULTS_STRICT: "true"
      ELASTICSEARCH_PORT: "9200"
      ELASTICSEARCH_PROTOCOL: http
      ELASTICSEARCH_USE_SSL: "false"
      ENTITY_REGISTRY_CONFIG_PATH: /datahub/datahub-gms/resources/entity-registry.yml
      ENTITY_SERVICE_ENABLE_RETENTION: "true"
      ENTITY_VERSIONING_ENABLED: "true"
      ES_BULK_REFRESH_POLICY: WAIT_UNTIL
      GRAPH_SERVICE_DIFF_MODE_ENABLED: "true"
      GRAPH_SERVICE_IMPL: elasticsearch
      JAVA_OPTS: -Xms1g -Xmx1g
      KAFKA_BOOTSTRAP_SERVER: datahub-kafka:29092
      KAFKA_SCHEMAREGISTRY_URL: http://datahub-gms:8080/schema-registry/api/
      MAE_CONSUMER_ENABLED: "true"
      MCE_CONSUMER_ENABLED: "true"
      METADATA_SERVICE_AUTH_ENABLED: "false"
      PE_CONSUMER_ENABLED: "true"
      SCHEMA_REGISTRY_TYPE: INTERNAL
      SEARCH_BAR_API_VARIANT: SEARCH_ACROSS_ENTITIES
      SHOW_HAS_SIBLINGS_FILTER: "true"
      SHOW_HOME_PAGE_REDESIGN: "true"
      SHOW_INGESTION_PAGE_REDESIGN: "true"
      SHOW_SEARCH_BAR_AUTOCOMPLETE_REDESIGN: "true"
      STRICT_URN_VALIDATION_ENABLED: "true"
      THEME_V2_DEFAULT: "true"
      UI_INGESTION_ENABLED: "true"
      UI_INGESTION_DEFAULT_CLI_VERSION: "head"
    ports:
      - "8080:8080"
    healthcheck:
      test:
        - CMD-SHELL
        - curl -sS --fail http://datahub-gms:8080/health
      interval: 10s
      timeout: 5s
      retries: 10
      start_period: 90s
    depends_on:
      datahub-system-update:
        condition: service_completed_successfully
    volumes:
      - type: bind
        source: ${HOME}/.datahub/plugins
        target: /etc/datahub/plugins
        bind:
          create_host_path: true
      - type: bind
        source: ${HOME}/.datahub/search
        target: /etc/datahub/search
        bind:
          create_host_path: true

  datahub-frontend:
    image: acryldata/datahub-frontend-react:head
    container_name: datahub-frontend
    restart: unless-stopped
    environment:
      DATAHUB_APP_VERSION: "head"
      DATAHUB_BASE_PATH: /
      DATAHUB_GMS_BASE_PATH: /
      DATAHUB_GMS_HOST: datahub-gms
      DATAHUB_GMS_PORT: "8080"
      DATAHUB_PLAY_MEM_BUFFER_SIZE: 10MB
      DATAHUB_SECRET: YouKnowNothing
      DATAHUB_TRACKING_TOPIC: DataHubUsageEvent_v1
      ELASTIC_CLIENT_HOST: datahub-opensearch
      ELASTIC_CLIENT_PORT: "9200"
      JAVA_OPTS: -Xms512m -Xmx512m -Dhttp.port=9002 -Dconfig.file=datahub-frontend/conf/application.conf -Djava.security.auth.login.config=datahub-frontend/conf/jaas.conf -Dlogback.configurationFile=datahub-frontend/conf/logback.xml -Dlogback.debug=false -Dpidfile.path=/dev/null
      KAFKA_BOOTSTRAP_SERVER: datahub-kafka:29092
      PLAY_HTTP_CONTEXT: /
      THEME_V2_DEFAULT: "true"
    ports:
      - "9002:9002"
    depends_on:
      datahub-gms:
        condition: service_healthy
      datahub-system-update:
        condition: service_completed_successfully
    volumes:
      - type: bind
        source: ${HOME}/.datahub/plugins
        target: /etc/datahub/plugins
        bind:
          create_host_path: true

  datahub-actions:
    image: acryldata/datahub-actions:head-slim
    container_name: datahub-actions
    restart: unless-stopped
    environment:
      ACTIONS_CONFIG: ""
      ACTIONS_EXTRA_PACKAGES: ""
      DATAHUB_GMS_HOST: datahub-gms
      DATAHUB_GMS_PORT: "8080"
      DATAHUB_GMS_PROTOCOL: http
      DATAHUB_SYSTEM_CLIENT_ID: __datahub_system
      DATAHUB_SYSTEM_CLIENT_SECRET: JohnSnowKnowsNothing
      ELASTICSEARCH_HOST: datahub-opensearch
      ELASTICSEARCH_PORT: "9200"
      ELASTICSEARCH_PROTOCOL: http
      ELASTICSEARCH_USE_SSL: "false"
      KAFKA_BOOTSTRAP_SERVER: datahub-kafka:29092
      KAFKA_PROPERTIES_SECURITY_PROTOCOL: PLAINTEXT
      METADATA_AUDIT_EVENT_NAME: MetadataAuditEvent_v4
      METADATA_CHANGE_LOG_VERSIONED_TOPIC_NAME: MetadataChangeLog_Versioned_v1
      SCHEMA_REGISTRY_URL: http://datahub-gms:8080/schema-registry/api/
    depends_on:
      datahub-gms:
        condition: service_healthy

  datahub-kafka:
    image: confluentinc/cp-kafka:8.0.0
    container_name: datahub-kafka
    restart: unless-stopped
    command:
      - /bin/bash
      - -c
      - |
        file_path="/var/lib/kafka/data/clusterID"

        if [ ! -f "$${file_path}" ]; then
           /bin/kafka-storage random-uuid > $${file_path}
           kafka-storage format --ignore-formatted -t $$(cat "$${file_path}") -c /etc/kafka/kafka.properties
        fi

        export CLUSTER_ID=$$(cat "$${file_path}")
        /etc/confluent/docker/run
    environment:
      KAFKA_ADVERTISED_LISTENERS: BROKER://datahub-kafka:29092,EXTERNAL://localhost:9092
      KAFKA_BROKER_ID: "1"
      KAFKA_CONFLUENT_SUPPORT_METRICS_ENABLE: "false"
      KAFKA_CONTROLLER_LISTENER_NAMES: CONTROLLER
      KAFKA_CONTROLLER_QUORUM_VOTERS: 1@datahub-kafka:39092
      KAFKA_GROUP_INITIAL_REBALANCE_DELAY_MS: "0"
      KAFKA_HEAP_OPTS: -Xms512m -Xmx512m
      KAFKA_INTER_BROKER_LISTENER_NAME: BROKER
      KAFKA_LISTENER_SECURITY_PROTOCOL_MAP: CONTROLLER:PLAINTEXT,BROKER:PLAINTEXT,EXTERNAL:PLAINTEXT
      KAFKA_LISTENERS: BROKER://datahub-kafka:29092,EXTERNAL://datahub-kafka:9092,CONTROLLER://datahub-kafka:39092
      KAFKA_LOG4J_LOGGERS: org.apache.kafka.image.loader.MetadataLoader=WARN
      KAFKA_MAX_MESSAGE_BYTES: "5242880"
      KAFKA_MESSAGE_MAX_BYTES: "5242880"
      KAFKA_NODE_ID: "1"
      KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR: "1"
      KAFKA_PROCESS_ROLES: controller, broker
    healthcheck:
      test:
        - CMD-SHELL
        - nc -z datahub-kafka 9092
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 60s
    ports:
      - "9092:9092"
    volumes:
      - datahub_kafka:/var/lib/kafka/data

  datahub-mysql:
    image: mysql:8.2
    container_name: datahub-mysql
    restart: unless-stopped
    command:
      - --character-set-server=utf8mb4
      - --collation-server=utf8mb4_bin
      - --default-authentication-plugin=caching_sha2_password
    environment:
      MYSQL_DATABASE: datahub
      MYSQL_PASSWORD: datahub
      MYSQL_ROOT_HOST: "%"
      MYSQL_ROOT_PASSWORD: datahub
      MYSQL_USER: datahub
    healthcheck:
      test:
        - CMD-SHELL
        - mysqladmin ping -h datahub-mysql -u $$MYSQL_USER --password=$$MYSQL_PASSWORD
      interval: 10s
      timeout: 10s
      retries: 5
      start_period: 20s
    volumes:
      - datahub_mysql:/var/lib/mysql

  datahub-mysql-setup:
    image: acryldata/datahub-mysql-setup:head
    container_name: datahub-mysql-setup
    restart: "no"
    environment:
      CDC_MCL_PROCESSING_ENABLED: "false"
      CDC_PASSWORD: datahub_cdc
      CDC_USER: datahub_cdc
      DATAHUB_DB_NAME: datahub
      MYSQL_HOST: datahub-mysql
      MYSQL_PASSWORD: datahub
      MYSQL_PORT: "3306"
      MYSQL_ROOT_PASSWORD: datahub
      MYSQL_USERNAME: datahub
    depends_on:
      datahub-mysql:
        condition: service_healthy

  datahub-opensearch:
    image: opensearchproject/opensearch:2.17.0
    container_name: datahub-opensearch
    restart: unless-stopped
    deploy:
      resources:
        limits:
          memory: "2g"
    environment:
      DISABLE_SECURITY_PLUGIN: "true"
      ES_JAVA_OPTS: -Xms256m -Xmx512m -Dlog4j2.formatMsgNoLookups=true
      OPENSEARCH_JAVA_OPTS: -Xms768m -Xmx1024m -Dlog4j2.formatMsgNoLookups=true
      discovery.type: single-node
      "cluster.routing.allocation.disk.threshold_enabled": "false"
      "cluster.routing.allocation.disk.watermark.low": "1gb"
      "cluster.routing.allocation.disk.watermark.high": "500mb"
      "cluster.routing.allocation.disk.watermark.flood_stage": "200mb"
    healthcheck:
      test:
        - CMD-SHELL
        - curl -sS --fail http://datahub-opensearch:9200/_cluster/health?wait_for_status=yellow&timeout=0s
      interval: 15s
      timeout: 15s
      retries: 10
      start_period: 60s
    volumes:
      - datahub_opensearch:/usr/share/opensearch/data

  datahub-opensearch-setup:
    image: acryldata/datahub-elasticsearch-setup:head
    container_name: datahub-opensearch-setup
    restart: on-failure
    command:
      - /bin/sh
      - -c
      - "sleep 20 && /create-indices.sh"
    environment:
      ELASTICSEARCH_HOST: datahub-opensearch
      ELASTICSEARCH_PORT: "9200"
      ELASTICSEARCH_PROTOCOL: http
      ELASTICSEARCH_USE_SSL: "false"
      USE_AWS_ELASTICSEARCH: "true"
    depends_on:
      datahub-opensearch:
        condition: service_healthy

  datahub-system-update:
    image: acryldata/datahub-upgrade:head
    container_name: datahub-system-update
    restart: on-failure
    command:
      - -u
      - SystemUpdate
    environment:
      BACKFILL_BROWSE_PATHS_V2: "true"
      DATAHUB_BASE_PATH: /
      DATAHUB_GMS_BASE_PATH: /
      DATAHUB_GMS_HOST: datahub-gms
      DATAHUB_GMS_PORT: "8080"
      DATAHUB_PRECREATE_TOPICS: "true"
      EBEAN_DATASOURCE_DRIVER: com.mysql.jdbc.Driver
      EBEAN_DATASOURCE_HOST: datahub-mysql:3306
      EBEAN_DATASOURCE_PASSWORD: datahub
      EBEAN_DATASOURCE_URL: jdbc:mysql://datahub-mysql:3306/datahub?verifyServerCertificate=false&useSSL=true&useUnicode=yes&characterEncoding=UTF-8&enabledTLSProtocols=TLSv1.2
      EBEAN_DATASOURCE_USERNAME: datahub
      ELASTICSEARCH_BUILD_INDICES_CLONE_INDICES: "false"
      ELASTICSEARCH_HOST: datahub-opensearch
      ELASTICSEARCH_IMPLEMENTATION: opensearch
      ELASTICSEARCH_INDEX_BUILDER_MAPPINGS_REINDEX: "true"
      ELASTICSEARCH_INDEX_BUILDER_REFRESH_INTERVAL_SECONDS: "3"
      ELASTICSEARCH_INDEX_BUILDER_SETTINGS_REINDEX: "true"
      ELASTICSEARCH_PORT: "9200"
      ELASTICSEARCH_PROTOCOL: http
      ELASTICSEARCH_USE_SSL: "false"
      ENTITY_REGISTRY_CONFIG_PATH: /datahub/datahub-gms/resources/entity-registry.yml
      ENTITY_VERSIONING_ENABLED: "true"
      GRAPH_SERVICE_IMPL: elasticsearch
      KAFKA_BOOTSTRAP_SERVER: datahub-kafka:29092
      KAFKA_SCHEMAREGISTRY_URL: http://datahub-gms:8080/schema-registry/api/
      REPROCESS_DEFAULT_BROWSE_PATHS_V2: "false"
      SCHEMA_REGISTRY_SYSTEM_UPDATE: "true"
      SCHEMA_REGISTRY_TYPE: INTERNAL
      SPRING_KAFKA_PROPERTIES_AUTO_REGISTER_SCHEMAS: "true"
      SPRING_KAFKA_PROPERTIES_USE_LATEST_VERSION: "true"
      USE_CONFLUENT_SCHEMA_REGISTRY: "false"
    depends_on:
      datahub-mysql:
        condition: service_healthy
      datahub-mysql-setup:
        condition: service_completed_successfully
      datahub-opensearch:
        condition: service_healthy
      datahub-opensearch-setup:
        condition: service_completed_successfully
      datahub-kafka:
        condition: service_started
    volumes:
      - type: bind
        source: ${HOME}/.datahub/plugins
        target: /etc/datahub/plugins
        bind:
          create_host_path: true

  # Airbyte for data ingestion
  airbyte-temporal:
    image: airbyte/temporal:0.50.33
    container_name: airbyte-temporal
    restart: unless-stopped
    environment:
      DB: postgresql
      DB_PORT: 5432
      LOG_LEVEL: INFO
      POSTGRES_PWD: airbyte
      POSTGRES_SEEDS: airbyte-db
      POSTGRES_USER: airbyte
    depends_on:
      airbyte-db:
        condition: service_healthy

  airbyte-db:
    image: postgres:13-alpine
    container_name: airbyte-db
    restart: unless-stopped
    environment:
      POSTGRES_USER: airbyte
      POSTGRES_PASSWORD: airbyte
      POSTGRES_DB: airbyte
    volumes:
      - ./volumes/airbyte-db:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U airbyte"]
      interval: 10s
      timeout: 5s
      retries: 5

  airbyte-bootloader:
    image: airbyte/bootloader:0.50.33
    container_name: airbyte-bootloader
    environment:
      DATABASE_USER: airbyte
      DATABASE_PASSWORD: airbyte
      DATABASE_HOST: airbyte-db
      DATABASE_PORT: 5432
      DATABASE_DB: airbyte
      DATABASE_URL: jdbc:postgresql://airbyte-db:5432/airbyte
      AIRBYTE_VERSION: 0.50.33
    depends_on:
      airbyte-db:
        condition: service_healthy

  airbyte-server:
    image: airbyte/server:0.50.33
    container_name: airbyte-server
    restart: unless-stopped
    environment:
      MICRONAUT_ENVIRONMENTS: control-plane
      DATABASE_USER: airbyte
      DATABASE_PASSWORD: airbyte
      DATABASE_HOST: airbyte-db
      DATABASE_PORT: 5432
      DATABASE_DB: airbyte
      DATABASE_URL: jdbc:postgresql://airbyte-db:5432/airbyte
      CONFIG_DATABASE_USER: airbyte
      CONFIG_DATABASE_PASSWORD: airbyte
      CONFIG_DATABASE_URL: jdbc:postgresql://airbyte-db:5432/airbyte
      WORKSPACE_ROOT: /workspace
      CONFIG_ROOT: /configs
      TRACKING_STRATEGY: logging
      LOCAL_ROOT: /tmp/airbyte_local
      WEBAPP_URL: http://localhost:8000
      TEMPORAL_HOST: airbyte-temporal:7233
      AIRBYTE_VERSION: 0.50.33
      CONFIGS_DATABASE_MINIMUM_FLYWAY_MIGRATION_VERSION: "0.35.15.001"
      JOBS_DATABASE_MINIMUM_FLYWAY_MIGRATION_VERSION: "0.29.15.001"
    ports:
      - "${AIRBYTE_API_PORT:-8001}:8001"
    volumes:
      - ./data/airbyte/workspace:/workspace
      - ./data/airbyte/configs:/configs
      - /tmp/airbyte_local:/tmp/airbyte_local
      - ./data:/data
    depends_on:
      airbyte-bootloader:
        condition: service_completed_successfully
      airbyte-db:
        condition: service_healthy
      airbyte-temporal:
        condition: service_started

  airbyte-webapp:
    image: airbyte/webapp:0.50.33
    container_name: airbyte-webapp
    restart: unless-stopped
    environment:
      INTERNAL_API_HOST: airbyte-server:8001
      CONNECTOR_BUILDER_API_HOST: airbyte-server:8003
      TRACKING_STRATEGY: logging
      KEYCLOAK_INTERNAL_HOST: localhost
    ports:
      - "${AIRBYTE_WEB_PORT:-8000}:80"
    depends_on:
      - airbyte-server

  airbyte-worker:
    image: airbyte/worker:0.50.33
    container_name: airbyte-worker
    restart: unless-stopped
    environment:
      MICRONAUT_ENVIRONMENTS: control-plane
      DATABASE_USER: airbyte
      DATABASE_PASSWORD: airbyte
      DATABASE_HOST: airbyte-db
      DATABASE_PORT: 5432
      DATABASE_DB: airbyte
      DATABASE_URL: jdbc:postgresql://airbyte-db:5432/airbyte
      CONFIG_DATABASE_USER: airbyte
      CONFIG_DATABASE_PASSWORD: airbyte
      CONFIG_DATABASE_URL: jdbc:postgresql://airbyte-db:5432/airbyte
      WORKSPACE_ROOT: /workspace
      CONFIG_ROOT: /configs
      LOCAL_ROOT: /tmp/airbyte_local
      AIRBYTE_VERSION: 0.50.33
      TEMPORAL_HOST: airbyte-temporal:7233
      TRACKING_STRATEGY: logging
      AIRBYTE_INTERNAL_API_HOST: airbyte-server:8001
      INTERNAL_API_HOST: airbyte-server:8001
      LOCAL_DOCKER_MOUNT: ${PWD}/data/airbyte/workspace
      WORKSPACE_DOCKER_MOUNT: ${PWD}/data/airbyte/workspace
    volumes:
      - ./data/airbyte/workspace:/workspace
      - ./data/airbyte/configs:/configs
      - /tmp/airbyte_local:/tmp/airbyte_local
      - ./data:/data
      - /var/run/docker.sock:/var/run/docker.sock
    depends_on:
      airbyte-bootloader:
        condition: service_completed_successfully
      airbyte-db:
        condition: service_healthy
      airbyte-temporal:
        condition: service_started

  airbyte-cron:
    image: airbyte/cron:0.50.33
    container_name: airbyte-cron
    restart: unless-stopped
    environment:
      MICRONAUT_ENVIRONMENTS: control-plane
      DATABASE_USER: airbyte
      DATABASE_PASSWORD: airbyte
      DATABASE_HOST: airbyte-db
      DATABASE_PORT: 5432
      DATABASE_DB: airbyte
      DATABASE_URL: jdbc:postgresql://airbyte-db:5432/airbyte
      WORKSPACE_ROOT: /workspace
      AIRBYTE_VERSION: 0.50.33
      CONFIGS_DATABASE_MINIMUM_FLYWAY_MIGRATION_VERSION: "0.35.15.001"
      JOBS_DATABASE_MINIMUM_FLYWAY_MIGRATION_VERSION: "0.29.15.001"
    volumes:
      - ./data/airbyte/workspace:/workspace
    depends_on:
      airbyte-bootloader:
        condition: service_completed_successfully

volumes:
  datahub_kafka:
  datahub_mysql:
  datahub_opensearch:
