name: superset
description: Apache Superset for business intelligence and data visualization
category: bi
default: true

image: apache/superset:${SUPERSET_VERSION:-4.0.0}

depends_on:
  - postgres
  - trino

compose:
  restart: unless-stopped
  labels:
    phlo.metrics.enabled: "false" # Superset doesn't expose native Prometheus metrics
  environment:
    SUPERSET_SECRET_KEY: ${SUPERSET_SECRET_KEY:-phlo-superset-secret-change-me}
    POSTGRES_HOST: postgres
    POSTGRES_PORT: 5432
    POSTGRES_USER: ${POSTGRES_USER:-phlo}
    POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-phlo}
    POSTGRES_DB: ${POSTGRES_DB:-phlo}
    SUPERSET_ADMIN_USER: ${SUPERSET_ADMIN_USER:-admin}
    SUPERSET_ADMIN_PASSWORD: ${SUPERSET_ADMIN_PASSWORD:-admin}
    SUPERSET_ADMIN_EMAIL: ${SUPERSET_ADMIN_EMAIL:-admin@example.com}
  command: >
    /bin/sh -c "
    superset db upgrade &&
    superset fab create-admin --username $${SUPERSET_ADMIN_USER} --firstname Admin --lastname User --email $${SUPERSET_ADMIN_EMAIL} --password $${SUPERSET_ADMIN_PASSWORD} || true &&
    superset init &&
    superset run -h 0.0.0.0 -p 8088 --with-threads
    "
  ports:
    - "${SUPERSET_PORT:-8088}:8088"
  volumes:
    - ./volumes/superset:/app/superset_home

env_vars:
  SUPERSET_VERSION:
    default: "4.0.0"
    description: Apache Superset version
  SUPERSET_PORT:
    default: 8088
    description: Superset web UI port
  SUPERSET_SECRET_KEY:
    default: phlo-superset-secret-change-me
    description: Superset secret key for session encryption
    secret: true
  SUPERSET_ADMIN_USER:
    default: admin
    description: Superset admin username
  SUPERSET_ADMIN_PASSWORD:
    default: admin
    description: Superset admin password
    secret: true
  SUPERSET_ADMIN_EMAIL:
    default: admin@example.com
    description: Superset admin email

hooks:
  post_start:
    - name: add-trino-database
      requires: phlo_trino
      command:
        - python
        - -m
        - phlo_superset.hooks
        - add-database
      timeout_seconds: 120
      environment:
        SUPERSET_URL: http://superset:8088
        TRINO_HOST: trino
        TRINO_PORT: "8080"
        TRINO_CATALOG: iceberg
