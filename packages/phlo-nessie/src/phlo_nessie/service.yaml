name: nessie
description: Git-like catalog for Iceberg tables with branch/merge support
category: core
default: true

image: ghcr.io/projectnessie/nessie:${NESSIE_VERSION:-0.106.0}

depends_on:
  - postgres
  - minio

compose:
  restart: unless-stopped
  environment:
    NESSIE_VERSION_STORE_TYPE: JDBC
    QUARKUS_DATASOURCE_JDBC_URL: jdbc:postgresql://postgres:5432/${POSTGRES_DB:-phlo}
    QUARKUS_DATASOURCE_USERNAME: ${POSTGRES_USER:-phlo}
    QUARKUS_DATASOURCE_PASSWORD: ${POSTGRES_PASSWORD:-phlo}
    nessie.catalog.default-warehouse: warehouse
    nessie.catalog.warehouses.warehouse.location: s3://lake/warehouse
    nessie.catalog.service.s3.default-options.endpoint: http://minio:9000/
    nessie.catalog.service.s3.default-options.path-style-access: "true"
    nessie.catalog.service.s3.default-options.region: us-east-1
    nessie.catalog.service.s3.default-options.access-key: urn:nessie-secret:quarkus:nessie.catalog.secrets.access-key
    nessie.catalog.secrets.access-key.name: ${MINIO_ROOT_USER:-minio}
    nessie.catalog.secrets.access-key.secret: ${MINIO_ROOT_PASSWORD:-minio123}
  ports:
    - "${NESSIE_PORT:-19120}:19120"
  healthcheck:
    test: ["CMD", "curl", "-f", "http://localhost:19120/api/v1/config"]
    interval: 10s
    timeout: 5s
    retries: 10
    start_period: 30s

env_vars:
  NESSIE_VERSION:
    default: "0.99.0"
    description: Nessie version
  NESSIE_PORT:
    default: 19120
    description: Nessie API port

hooks:
  post_start:
    - name: init-branches
      command:
        - python
        - -m
        - phlo_nessie.hooks
        - init-branches
      timeout_seconds: 60
