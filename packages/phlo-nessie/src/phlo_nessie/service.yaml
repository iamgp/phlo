name: nessie
description: Git-like catalog for Iceberg tables with branch/merge support
category: core
default: true

image: ghcr.io/projectnessie/nessie:${NESSIE_VERSION:-0.106.0}

depends_on:
  - postgres
  - minio

compose:
  restart: unless-stopped
  environment:
    NESSIE_VERSION_STORE_TYPE: JDBC
    QUARKUS_DATASOURCE_JDBC_URL: jdbc:postgresql://postgres:5432/${POSTGRES_DB:-phlo}
    QUARKUS_DATASOURCE_USERNAME: ${POSTGRES_USER:-phlo}
    QUARKUS_DATASOURCE_PASSWORD: ${POSTGRES_PASSWORD:-phlo}
    nessie.catalog.default-warehouse: warehouse
    nessie.catalog.warehouses.warehouse.location: s3://lake/warehouse
    nessie.catalog.service.s3.default-options.endpoint: http://minio:9000/
    nessie.catalog.service.s3.default-options.path-style-access: "true"
    nessie.catalog.service.s3.default-options.region: us-east-1
    nessie.catalog.service.s3.default-options.access-key: urn:nessie-secret:quarkus:nessie.catalog.secrets.access-key
    nessie.catalog.secrets.access-key.name: ${MINIO_ROOT_USER:-minio}
    nessie.catalog.secrets.access-key.secret: ${MINIO_ROOT_PASSWORD:-minio123}
    # OIDC Authentication (Quarkus)
    QUARKUS_OIDC_ENABLED: ${NESSIE_OIDC_ENABLED:-false}
    QUARKUS_OIDC_AUTH_SERVER_URL: ${NESSIE_OIDC_SERVER_URL:-}
    QUARKUS_OIDC_CLIENT_ID: ${NESSIE_OIDC_CLIENT_ID:-}
    QUARKUS_OIDC_CREDENTIALS_SECRET: ${NESSIE_OIDC_CLIENT_SECRET:-}
    QUARKUS_OIDC_TOKEN_ISSUER: ${NESSIE_OIDC_ISSUER:-}
    # Authorization
    NESSIE_SERVER_AUTHORIZATION_ENABLED: ${NESSIE_AUTHZ_ENABLED:-false}
  ports:
    - "${NESSIE_PORT:-19120}:19120"
  healthcheck:
    test: ["CMD", "curl", "-f", "http://localhost:19120/api/v1/config"]
    interval: 10s
    timeout: 5s
    retries: 10
    start_period: 30s

env_vars:
  NESSIE_VERSION:
    default: "0.99.0"
    description: Nessie version
  NESSIE_PORT:
    default: 19120
    description: Nessie API port
  # OIDC Authentication
  NESSIE_OIDC_ENABLED:
    default: "false"
    description: "Enable OIDC/OAuth2 authentication"
  NESSIE_OIDC_SERVER_URL:
    default: ""
    description: "OIDC server URL (e.g., https://auth.example.com/realms/phlo)"
  NESSIE_OIDC_CLIENT_ID:
    default: ""
    description: "OIDC client ID"
  NESSIE_OIDC_CLIENT_SECRET:
    default: ""
    description: "OIDC client secret"
    secret: true
  NESSIE_OIDC_ISSUER:
    default: ""
    description: "OIDC token issuer URL (if different from server URL)"
  # Authorization
  NESSIE_AUTHZ_ENABLED:
    default: "false"
    description: "Enable Nessie authorization rules"

hooks:
  post_start:
    - name: init-branches
      command:
        - python
        - -m
        - phlo_nessie.hooks
        - init-branches
      timeout_seconds: 60
