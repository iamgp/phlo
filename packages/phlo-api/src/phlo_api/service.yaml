name: phlo-api
description: Phlo API - Backend service exposing phlo internals to Observatory
category: api
default: true

# Production: use published Docker image
image: ghcr.io/iamgp/phlo-api:latest

compose:
  restart: unless-stopped
  labels:
    phlo.metrics.enabled: "true"
    phlo.metrics.port: "phlo-api:4000"
    phlo.metrics.path: "/metrics"
  environment:
    HOST: 0.0.0.0
    PORT: 4000
    PYTHONUNBUFFERED: "1"
  ports:
    - "${PHLO_API_PORT:-4000}:4000"
  healthcheck:
    test: ["CMD", "curl", "-f", "http://127.0.0.1:4000/health"]
    interval: 30s
    timeout: 10s
    retries: 3
    start_period: 10s

env_vars:
  PHLO_API_PORT:
    default: 4000
    description: Phlo API port

# Dev mode: run as subprocess (no Docker)
dev:
  command:
    [
      "uvicorn",
      "phlo_api.main:app",
      "--host",
      "0.0.0.0",
      "--port",
      "${PHLO_API_PORT:-4000}",
      "--reload",
    ]
  environment:
    PYTHONUNBUFFERED: "1"
    PHLO_DEV_MODE: "true"
    DAGSTER_GRAPHQL_URL: "http://127.0.0.1:${DAGSTER_PORT:-3000}/graphql"
    NESSIE_URL: "http://127.0.0.1:${NESSIE_PORT:-19120}/api/v2"
    TRINO_URL: "http://127.0.0.1:${TRINO_PORT:-8080}"
  health_check: "http://127.0.0.1:${PHLO_API_PORT:-4000}/health"
  cwd: "{project_root}"
