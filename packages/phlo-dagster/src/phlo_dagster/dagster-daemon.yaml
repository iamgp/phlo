# Companion service for dagster - runs the daemon for schedules/sensors
name: dagster-daemon
description: Dagster daemon for schedules, sensors, and run queue
category: orchestration
default: true
phlo_dev: true

build:
  context: .
  dockerfile: dagster/Dockerfile
  args:
    PHLO_VERSION: ${PHLO_VERSION:-}

depends_on:
  - dagster

compose:
  restart: unless-stopped
  environment:
    DAGSTER_HOME: /opt/dagster
    PYTHONPATH: /opt/dagster:/app
    MINIO_ROOT_USER: ${MINIO_ROOT_USER:-minio}
    MINIO_ROOT_PASSWORD: ${MINIO_ROOT_PASSWORD:-minio123}
    AWS_ACCESS_KEY_ID: ${MINIO_ROOT_USER:-minio}
    AWS_SECRET_ACCESS_KEY: ${MINIO_ROOT_PASSWORD:-minio123}
    AWS_REGION: us-east-1
    AWS_S3_ENDPOINT: http://minio:9000
    AWS_S3_USE_SSL: "false"
    AWS_S3_URL_STYLE: "path"
    NESSIE_HOST: nessie
    NESSIE_PORT: 19120
    TRINO_HOST: trino
    TRINO_PORT: 8080
    TRINO_CATALOG: iceberg
    ICEBERG_WAREHOUSE_PATH: s3://lake/warehouse
    ICEBERG_STAGING_PATH: s3://lake/stage
    POSTGRES_HOST: postgres
    POSTGRES_PORT: 5432
    POSTGRES_USER: ${POSTGRES_USER:-phlo}
    POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-phlo}
    POSTGRES_DB: ${POSTGRES_DB:-phlo}
    WORKFLOWS_PATH: /app/workflows
    DBT_PROJECT_DIR: /app/transforms/dbt
    SUPERSET_ADMIN_PASSWORD: ${SUPERSET_ADMIN_PASSWORD:-admin}
    PHLO_HOST_PLATFORM: ${PHLO_HOST_PLATFORM:-}
    DISABLE_PANDERA_IMPORT_WARNING: "True"
  command: ["dagster-daemon", "run", "-w", "/opt/dagster/workspace.yaml"]
  volumes:
    - ./dagster:/opt/dagster
    - ../workflows:/app/workflows:ro
    - ../transforms:/app/transforms
    - ../tests:/app/tests:ro
