name: dagster
description: Data orchestration platform for workflows and pipelines
category: orchestration
default: true
phlo_dev: true

build:
  context: .
  dockerfile: dagster/Dockerfile
  args:
    PHLO_VERSION: ${PHLO_VERSION:-}

depends_on:
  - postgres
  - minio
  - nessie
  - trino

compose:
  restart: unless-stopped
  labels:
    phlo.metrics.enabled: "true"
    phlo.metrics.port: "dagster:3000"
    phlo.metrics.path: "/metrics"
  environment:
    DAGSTER_HOME: /opt/dagster
    PYTHONPATH: /opt/dagster:/app
    MINIO_ROOT_USER: ${MINIO_ROOT_USER:-minio}
    MINIO_ROOT_PASSWORD: ${MINIO_ROOT_PASSWORD:-minio123}
    AWS_ACCESS_KEY_ID: ${MINIO_ROOT_USER:-minio}
    AWS_SECRET_ACCESS_KEY: ${MINIO_ROOT_PASSWORD:-minio123}
    AWS_REGION: us-east-1
    AWS_S3_ENDPOINT: http://minio:9000
    AWS_S3_USE_SSL: "false"
    AWS_S3_URL_STYLE: "path"
    NESSIE_HOST: nessie
    NESSIE_PORT: 19120
    TRINO_HOST: trino
    TRINO_PORT: 8080
    TRINO_CATALOG: iceberg
    ICEBERG_WAREHOUSE_PATH: s3://lake/warehouse
    ICEBERG_STAGING_PATH: s3://lake/stage
    POSTGRES_HOST: postgres
    POSTGRES_PORT: 5432
    POSTGRES_USER: ${POSTGRES_USER:-phlo}
    POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-phlo}
    POSTGRES_DB: ${POSTGRES_DB:-phlo}
    WORKFLOWS_PATH: /app/workflows
    DBT_PROJECT_DIR: /app/transforms/dbt
    SUPERSET_ADMIN_PASSWORD: ${SUPERSET_ADMIN_PASSWORD:-admin}
    PHLO_HOST_PLATFORM: ${PHLO_HOST_PLATFORM:-}
  command:
    [
      "dagster-webserver",
      "-h",
      "0.0.0.0",
      "-p",
      "3000",
      "-w",
      "/opt/dagster/workspace.yaml",
    ]
  ports:
    - "${DAGSTER_PORT:-3000}:3000"
  volumes:
    - ./dagster:/opt/dagster
    - ../workflows:/app/workflows:ro
    - ../transforms:/app/transforms
    - ../tests:/app/tests:ro

env_vars:
  DAGSTER_PORT:
    default: 3000
    description: Dagster webserver port
  PHLO_VERSION:
    default: ""
    description: Phlo version to install (empty for latest)
  PHLO_HOST_PLATFORM:
    default: ""
    description: Host platform for executor selection (Darwin/Linux)

hooks:
  post_start:
    - name: dbt-compile
      requires: phlo_dbt
      command:
        - python
        - -m
        - phlo_dbt.hooks
        - compile
      timeout_seconds: 180

files:
  - source: Dockerfile
    dest: dagster/Dockerfile
  - source: entrypoint.sh
    dest: dagster/entrypoint.sh
  - source: templates/workspace.yaml
    dest: dagster/workspace.yaml
  - source: templates/dagster.yaml
    dest: dagster/dagster.yaml
