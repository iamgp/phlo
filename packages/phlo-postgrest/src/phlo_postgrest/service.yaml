name: postgrest
description: RESTful API automatically generated from PostgreSQL schema
category: api
default: false
profile: api

image: postgrest/postgrest:${POSTGREST_VERSION:-v12.2.3}

depends_on:
  - postgres

compose:
  restart: unless-stopped
  labels:
    phlo.metrics.enabled: "false"
  command: ["/bin/postgrest", "/etc/postgrest/postgrest.conf"]
  volumes:
    - ./postgrest/conf:/etc/postgrest:ro
  ports:
    - "${POSTGREST_PORT:-3002}:3000"
  healthcheck:
    test: ["CMD", "wget", "-q", "--spider", "http://localhost:3000/"]
    interval: 10s
    timeout: 5s
    retries: 5

env_vars:
  POSTGREST_VERSION:
    default: v12.2.3
    description: PostgREST version
  POSTGREST_PORT:
    default: 3002
    description: PostgREST API port
  PGRST_DB_SCHEMAS:
    default: public
    description: Comma-separated list of schemas to expose (auto-configured by hook)

files:
  - source: conf
    dest: postgrest/conf

hooks:
  post_start:
    - name: configure-schemas
      delay: 5
      command:
        - python
        - -m
        - phlo_postgrest.hooks
        - configure-schemas
      timeout_seconds: 60
