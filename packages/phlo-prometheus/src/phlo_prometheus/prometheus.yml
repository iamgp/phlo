global:
  scrape_interval: 15s
  evaluation_interval: 15s

scrape_configs:
  # Prometheus self-monitoring
  - job_name: "prometheus"
    static_configs:
      - targets: ["localhost:9090"]

  # Auto-discover phlo services via Docker labels
  # Services opt-in by setting label: phlo.metrics.enabled=true
  - job_name: "phlo-services"
    docker_sd_configs:
      - host: "unix:///var/run/docker.sock"
        refresh_interval: 30s
    relabel_configs:
      # Only scrape containers with phlo.metrics.enabled=true
      - source_labels: [__meta_docker_container_label_phlo_metrics_enabled]
        regex: "true"
        action: keep
      # Use container name as job label
      - source_labels: [__meta_docker_container_name]
        regex: "/?(.*)"
        target_label: container
      # Use custom port if specified, else default to 8080
      - source_labels: [__meta_docker_container_label_phlo_metrics_port]
        regex: "(.+)"
        target_label: __address__
        replacement: "${1}"
      # Use custom metrics path if specified
      - source_labels: [__meta_docker_container_label_phlo_metrics_path]
        regex: "(.+)"
        target_label: __metrics_path__
      # Extract service name from compose label
      - source_labels:
          [__meta_docker_container_label_com_docker_compose_service]
        target_label: service
      # Extract project name
      - source_labels:
          [__meta_docker_container_label_com_docker_compose_project]
        target_label: project
