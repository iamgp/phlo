name: alloy
description: Grafana Alloy for log collection and shipping to Loki
category: observability
default: false
profile: observability

image: grafana/alloy:v1.4.2

compose:
  restart: unless-stopped
  labels:
    phlo.metrics.enabled: "true"
    phlo.metrics.port: "alloy:12345"
    phlo.metrics.path: "/metrics"
  command:
    - run
    - --server.http.listen-addr=0.0.0.0:12345
    - /etc/alloy/config.alloy
  ports:
    - "${ALLOY_PORT:-12345}:12345"
  volumes:
    - ./alloy/config.alloy:/etc/alloy/config.alloy:ro
    - /var/run/docker.sock:/var/run/docker.sock:ro
  depends_on:
    loki:
      condition: service_healthy
  healthcheck:
    test:
      [
        "CMD",
        "wget",
        "--quiet",
        "--tries=1",
        "--spider",
        "http://localhost:12345/-/ready",
      ]
    interval: 10s
    timeout: 5s
    retries: 5

env_vars:
  ALLOY_PORT:
    default: 12345
    description: Alloy HTTP port

files:
  - source: config.alloy
    dest: alloy/config.alloy
