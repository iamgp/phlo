name: hasura
description: GraphQL API engine with real-time subscriptions
category: api
default: false
profile: api

image: hasura/graphql-engine:${HASURA_VERSION:-v2.46.0}

depends_on:
  - postgres

compose:
  restart: unless-stopped
  labels:
    phlo.metrics.enabled: "true"
    phlo.metrics.port: "hasura:8080"
    phlo.metrics.path: "/v1/metrics"
  environment:
    HASURA_GRAPHQL_DATABASE_URL: postgresql://${POSTGRES_USER:-phlo}:${POSTGRES_PASSWORD:-phlo}@postgres:5432/${POSTGRES_DB:-phlo}
    HASURA_GRAPHQL_ENABLE_CONSOLE: "true"
    HASURA_GRAPHQL_DEV_MODE: "true"
    HASURA_GRAPHQL_ENABLED_LOG_TYPES: startup, http-log, webhook-log, websocket-log, query-log
    HASURA_GRAPHQL_ADMIN_SECRET: ${HASURA_ADMIN_SECRET:-phlo-hasura-admin-secret}
    HASURA_GRAPHQL_UNAUTHORIZED_ROLE: anonymous
  ports:
    - "${HASURA_PORT:-8082}:8080"
  healthcheck:
    test: ["CMD", "wget", "-q", "--spider", "http://localhost:8080/healthz"]
    interval: 10s
    timeout: 5s
    retries: 5

env_vars:
  HASURA_VERSION:
    default: v2.46.0
    description: Hasura GraphQL Engine version
  HASURA_PORT:
    default: 8082
    description: Hasura console and API port
  HASURA_ADMIN_SECRET:
    default: phlo-hasura-admin-secret
    description: Hasura admin secret for console access
    secret: true

hooks:
  post_start:
    - name: track-tables
      delay: 5
      command:
        - python
        - -m
        - phlo_hasura.hooks
        - track-tables
        - marts,api
      timeout_seconds: 60
