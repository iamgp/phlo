
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="Documentation for the Phlo data lakehouse platform">
      
      
        <meta name="author" content="Phlo Team">
      
      
      
      
      
        
      
      
      <link rel="icon" href="../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.7.1">
    
    
      
        <title>Part 9: Data Quality—Pandera Schemas and Asset Checks - Phlo Lakehouse Platform</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.484c7ddc.min.css">
      
        
        <link rel="stylesheet" href="../../assets/stylesheets/palette.ab4e12ef.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../../assets/_mkdocstrings.css">
    
    <script>__md_scope=new URL("../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
  </head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="indigo" data-md-color-accent="indigo">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#part-9-data-qualitypandera-schemas-and-asset-checks" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../.." title="Phlo Lakehouse Platform" class="md-header__button md-logo" aria-label="Phlo Lakehouse Platform" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Phlo Lakehouse Platform
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Part 9: Data Quality—Pandera Schemas and Asset Checks
            
          </span>
        </div>
      </div>
    </div>
    
      
        <form class="md-header__option" data-md-component="palette">
  
    
    
    
    <input class="md-option" data-md-color-media="(prefers-color-scheme)" data-md-color-scheme="default" data-md-color-primary="indigo" data-md-color-accent="indigo"  aria-label="Switch to light mode"  type="radio" name="__palette" id="__palette_0">
    
      <label class="md-header__button md-icon" title="Switch to light mode" for="__palette_1" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="m14.3 16-.7-2h-3.2l-.7 2H7.8L11 7h2l3.2 9zM20 8.69V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12zm-9.15 3.96h2.3L12 9z"/></svg>
      </label>
    
  
    
    
    
    <input class="md-option" data-md-color-media="(prefers-color-scheme: light)" data-md-color-scheme="default" data-md-color-primary="indigo" data-md-color-accent="indigo"  aria-label="Switch to dark mode"  type="radio" name="__palette" id="__palette_1">
    
      <label class="md-header__button md-icon" title="Switch to dark mode" for="__palette_2" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a4 4 0 0 0-4 4 4 4 0 0 0 4 4 4 4 0 0 0 4-4 4 4 0 0 0-4-4m0 10a6 6 0 0 1-6-6 6 6 0 0 1 6-6 6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12z"/></svg>
      </label>
    
  
    
    
    
    <input class="md-option" data-md-color-media="(prefers-color-scheme: dark)" data-md-color-scheme="slate" data-md-color-primary="indigo" data-md-color-accent="indigo"  aria-label="Switch to system preference"  type="radio" name="__palette" id="__palette_2">
    
      <label class="md-header__button md-icon" title="Switch to system preference" for="__palette_0" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 18c-.89 0-1.74-.2-2.5-.55C11.56 16.5 13 14.42 13 12s-1.44-4.5-3.5-5.45C10.26 6.2 11.11 6 12 6a6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12z"/></svg>
      </label>
    
  
</form>
      
    
    
      <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      
      
        <label class="md-header__button md-icon" for="__search">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        </label>
        <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
          <a href="javascript:void(0)" class="md-search__icon md-icon" title="Share" aria-label="Share" data-clipboard data-clipboard-text="" data-md-component="search-share" tabindex="-1">
            
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M18 16.08c-.76 0-1.44.3-1.96.77L8.91 12.7c.05-.23.09-.46.09-.7s-.04-.47-.09-.7l7.05-4.11c.54.5 1.25.81 2.04.81a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3c0 .24.04.47.09.7L8.04 9.81C7.5 9.31 6.79 9 6 9a3 3 0 0 0-3 3 3 3 0 0 0 3 3c.79 0 1.5-.31 2.04-.81l7.12 4.15c-.05.21-.08.43-.08.66 0 1.61 1.31 2.91 2.92 2.91s2.92-1.3 2.92-2.91A2.92 2.92 0 0 0 18 16.08"/></svg>
          </a>
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
        <div class="md-search__suggest" data-md-component="search-suggest"></div>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
      
    
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    



<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../.." title="Phlo Lakehouse Platform" class="md-nav__button md-logo" aria-label="Phlo Lakehouse Platform" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    Phlo Lakehouse Platform
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../.." class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Home
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
      
        
      
        
      
    
    
    
    
      
        
        
      
    
    <li class="md-nav__item md-nav__item--pruned md-nav__item--nested">
      
        
  
  
  
    <a href="../../getting-started/installation/" class="md-nav__link">
      
  
  
  <span class="md-ellipsis">
    
  
    Getting Started
  

    
  </span>
  
  

      
        <span class="md-nav__icon md-icon"></span>
      
    </a>
  

      
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
    
    
    
    
      
        
        
      
    
    <li class="md-nav__item md-nav__item--pruned md-nav__item--nested">
      
        
  
  
  
    <a href="../../guides/developer-guide/" class="md-nav__link">
      
  
  
  <span class="md-ellipsis">
    
  
    Guides
  

    
  </span>
  
  

      
        <span class="md-nav__icon md-icon"></span>
      
    </a>
  

      
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
      
        
      
        
      
        
      
        
      
    
    
    
    
      
        
        
      
    
    <li class="md-nav__item md-nav__item--pruned md-nav__item--nested">
      
        
  
  
  
    <a href="../../setup/hasura/" class="md-nav__link">
      
  
  
  <span class="md-ellipsis">
    
  
    Setup
  

    
  </span>
  
  

      
        <span class="md-nav__icon md-icon"></span>
      
    </a>
  

      
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
          
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
    
    
    
    
      
        
        
      
    
    <li class="md-nav__item md-nav__item--pruned md-nav__item--nested">
      
        
  
  
  
    <a href="../../packages/" class="md-nav__link">
      
  
  
  <span class="md-ellipsis">
    
  
    Packages
  

    
  </span>
  
  

      
        <span class="md-nav__icon md-icon"></span>
      
    </a>
  

      
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
      
        
      
        
      
        
      
        
      
        
      
    
    
    
    
      
        
        
      
    
    <li class="md-nav__item md-nav__item--pruned md-nav__item--nested">
      
        
  
  
  
    <a href="../../reference/architecture/" class="md-nav__link">
      
  
  
  <span class="md-ellipsis">
    
  
    Reference
  

    
  </span>
  
  

      
        <span class="md-nav__icon md-icon"></span>
      
    </a>
  

      
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
      
        
      
        
      
        
      
    
    
    
    
      
        
        
      
    
    <li class="md-nav__item md-nav__item--pruned md-nav__item--nested">
      
        
  
  
  
    <a href="../../operations/operations-guide/" class="md-nav__link">
      
  
  
  <span class="md-ellipsis">
    
  
    Operations
  

    
  </span>
  
  

      
        <span class="md-nav__icon md-icon"></span>
      
    </a>
  

      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#the-data-quality-problem" class="md-nav__link">
    <span class="md-ellipsis">
      
        The Data Quality Problem
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#three-layers-of-validation" class="md-nav__link">
    <span class="md-ellipsis">
      
        Three Layers of Validation
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#layer-1-pandera-schemas-ingestion" class="md-nav__link">
    <span class="md-ellipsis">
      
        Layer 1: Pandera Schemas (Ingestion)
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Layer 1: Pandera Schemas (Ingestion)">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#setting-up-a-schema" class="md-nav__link">
    <span class="md-ellipsis">
      
        Setting Up a Schema
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#using-pandera-in-phlo_ingestion" class="md-nav__link">
    <span class="md-ellipsis">
      
        Using Pandera in @phlo_ingestion
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#detailed-error-messages" class="md-nav__link">
    <span class="md-ellipsis">
      
        Detailed Error Messages
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#layer-2-dbt-tests-transformations" class="md-nav__link">
    <span class="md-ellipsis">
      
        Layer 2: dbt Tests (Transformations)
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Layer 2: dbt Tests (Transformations)">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#schema-tests-yaml-based" class="md-nav__link">
    <span class="md-ellipsis">
      
        Schema Tests (YAML-based)
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#custom-tests-sql" class="md-nav__link">
    <span class="md-ellipsis">
      
        Custom Tests (SQL)
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#running-dbt-tests" class="md-nav__link">
    <span class="md-ellipsis">
      
        Running dbt Tests
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#layer-3-dagster-asset-checks-runtime" class="md-nav__link">
    <span class="md-ellipsis">
      
        Layer 3: Dagster Asset Checks (Runtime)
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Layer 3: Dagster Asset Checks (Runtime)">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#approach-1-phlo_quality-decorator-declarative" class="md-nav__link">
    <span class="md-ellipsis">
      
        Approach 1: @phlo_quality Decorator (Declarative)
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#approach-2-traditional-asset_check-custom-logic" class="md-nav__link">
    <span class="md-ellipsis">
      
        Approach 2: Traditional @asset_check (Custom Logic)
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#viewing-check-results" class="md-nav__link">
    <span class="md-ellipsis">
      
        Viewing Check Results
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#comparing-both-approaches" class="md-nav__link">
    <span class="md-ellipsis">
      
        Comparing Both Approaches
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Comparing Both Approaches">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#phlo_quality-declarative-10-lines" class="md-nav__link">
    <span class="md-ellipsis">
      
        @phlo_quality: Declarative (10 lines)
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#traditional-asset_check-custom-logic-80-lines" class="md-nav__link">
    <span class="md-ellipsis">
      
        Traditional @asset_check: Custom Logic (80+ lines)
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#available-check-types" class="md-nav__link">
    <span class="md-ellipsis">
      
        Available Check Types
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#check-parameters-in-detail" class="md-nav__link">
    <span class="md-ellipsis">
      
        Check Parameters in Detail
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#decorator-parameters" class="md-nav__link">
    <span class="md-ellipsis">
      
        Decorator Parameters
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#combining-with-pandera-schemas" class="md-nav__link">
    <span class="md-ellipsis">
      
        Combining with Pandera Schemas
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#when-to-use-each-approach" class="md-nav__link">
    <span class="md-ellipsis">
      
        When to Use Each Approach
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#validation-at-each-layer" class="md-nav__link">
    <span class="md-ellipsis">
      
        Validation at Each Layer
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Validation at Each Layer">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#why-three-layers" class="md-nav__link">
    <span class="md-ellipsis">
      
        Why Three Layers?
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#practical-example-catching-a-bug" class="md-nav__link">
    <span class="md-ellipsis">
      
        Practical Example: Catching a Bug
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#configuring-validation-strictness" class="md-nav__link">
    <span class="md-ellipsis">
      
        Configuring Validation Strictness
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#monitoring-dashboard" class="md-nav__link">
    <span class="md-ellipsis">
      
        Monitoring Dashboard
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#summary" class="md-nav__link">
    <span class="md-ellipsis">
      
        Summary
      
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              
              <article class="md-content__inner md-typeset">
                
                  



<h1 id="part-9-data-qualitypandera-schemas-and-asset-checks">Part 9: Data Quality—Pandera Schemas and Asset Checks</h1>
<p>In Part 8, we built a complete pipeline. But how do we ensure data quality throughout? This post covers validation at multiple layers.</p>
<h2 id="the-data-quality-problem">The Data Quality Problem</h2>
<p>Without validation, bad data silently propagates:</p>
<pre><code class="language-python"># This data is... problematic
glucose_reading = {
    &quot;glucose_mg_dl&quot;: -50,  # Negative? Impossible
    &quot;timestamp&quot;: &quot;2024-13-45&quot;,  # Invalid date
    &quot;device&quot;: None,  # Required field missing
    &quot;reading_type&quot;: &quot;unknown&quot;,  # Invalid enum
}

# Query downstream just sees rows
# Dashboard shows glucose values from -50 to 5000
# Alerts fire for impossible &quot;low&quot; readings
</code></pre>
<h2 id="three-layers-of-validation">Three Layers of Validation</h2>
<p>Phlo uses validation at three points:</p>
<pre><code>API Data
    ↓
[1] Ingestion: Pandera schema validation
    ↓
DLT Staging Tables
    ↓
[2] dbt Tests: Business logic validation
    ↓
Iceberg/Postgres Marts
    ↓
[3] Dagster Asset Checks: Runtime monitoring
    ↓
Dashboards/Alerts
</code></pre>
<h2 id="layer-1-pandera-schemas-ingestion">Layer 1: Pandera Schemas (Ingestion)</h2>
<p>Pandera provides type-safe validation with detailed error reporting.</p>
<h3 id="setting-up-a-schema">Setting Up a Schema</h3>
<p>Phlo uses Pandera's DataFrameModel approach for cleaner, class-based schemas:</p>
<pre><code class="language-python"># File: phlo-examples/nightscout/workflows/schemas/nightscout.py
from pandera.pandas import DataFrameModel, Field

# Validation constants
MIN_GLUCOSE_MG_DL = 20
MAX_GLUCOSE_MG_DL = 600

VALID_DIRECTIONS = [
    &quot;Flat&quot;, &quot;FortyFiveUp&quot;, &quot;FortyFiveDown&quot;,
    &quot;SingleUp&quot;, &quot;SingleDown&quot;, &quot;DoubleUp&quot;, &quot;DoubleDown&quot;, &quot;NONE&quot;
]


class RawGlucoseEntries(DataFrameModel):
    &quot;&quot;&quot;
    Schema for raw Nightscout glucose entries from the API.

    Validates raw glucose data at ingestion time:
    - Valid glucose ranges (1-1000 mg/dL for raw data)
    - Proper field types and nullability
    - Required metadata fields
    - Unique entry IDs
    &quot;&quot;&quot;

    _id: str = Field(
        nullable=False,
        unique=True,
        description=&quot;Nightscout entry ID (unique identifier)&quot;,
    )

    sgv: int = Field(
        ge=1,
        le=1000,
        nullable=False,
        description=&quot;Sensor glucose value in mg/dL (1-1000 for raw data)&quot;,
    )

    date: int = Field(
        nullable=False,
        description=&quot;Unix timestamp in milliseconds&quot;,
    )

    date_string: datetime = Field(
        nullable=False,
        description=&quot;ISO 8601 timestamp&quot;,
    )

    direction: str | None = Field(
        isin=VALID_DIRECTIONS,
        nullable=True,
        description=&quot;Trend direction (e.g., 'SingleUp', 'Flat')&quot;,
    )

    device: str | None = Field(
        nullable=True,
        description=&quot;Device name that recorded the entry&quot;,
    )

    class Config:
        strict = False  # Allow DLT metadata fields
        coerce = True


class FactGlucoseReadings(DataFrameModel):
    &quot;&quot;&quot;
    Schema for the fct_glucose_readings table (silver layer).

    Validates processed Nightscout glucose data including:
    - Valid glucose ranges (20-600 mg/dL)
    - Proper timestamp formatting
    - Valid direction indicators
    - Time dimension fields (hour, day of week)
    - Glucose categorization
    &quot;&quot;&quot;

    entry_id: str = Field(
        nullable=False,
        unique=True,
        description=&quot;Unique identifier for each glucose reading entry&quot;,
    )

    glucose_mg_dl: int = Field(
        ge=MIN_GLUCOSE_MG_DL,
        le=MAX_GLUCOSE_MG_DL,
        nullable=False,
        description=f&quot;Blood glucose in mg/dL ({MIN_GLUCOSE_MG_DL}-{MAX_GLUCOSE_MG_DL})&quot;,
    )

    reading_timestamp: datetime = Field(
        nullable=False,
        description=&quot;Timestamp when the glucose reading was taken&quot;,
    )

    hour_of_day: int = Field(
        ge=0,
        le=23,
        nullable=False,
        description=&quot;Hour of day when reading was taken (0-23)&quot;,
    )

    glucose_category: str = Field(
        isin=[&quot;hypoglycemia&quot;, &quot;in_range&quot;, &quot;hyperglycemia_mild&quot;, &quot;hyperglycemia_severe&quot;],
        nullable=False,
        description=&quot;Categorized glucose level based on ADA guidelines&quot;,
    )

    is_in_range: int = Field(
        isin=[0, 1],
        nullable=False,
        description=&quot;Whether glucose level is within target range (0=no, 1=yes)&quot;,
    )

    class Config:
        strict = True
        coerce = True
</code></pre>
<h3 id="using-pandera-in-phlo_ingestion">Using Pandera in @phlo_ingestion</h3>
<p>The <code>@phlo_ingestion</code> decorator automatically validates data with Pandera schemas:</p>
<pre><code class="language-python"># File: phlo-examples/nightscout/workflows/ingestion/nightscout/readings.py

import phlo
from dlt.sources.rest_api import rest_api
from workflows.schemas.nightscout import RawGlucoseEntries

@phlo_ingestion(
    table_name=&quot;glucose_entries&quot;,
    unique_key=&quot;_id&quot;,
    validation_schema=RawGlucoseEntries,  # Automatic validation
    group=&quot;nightscout&quot;,
    cron=&quot;0 */1 * * *&quot;,
    freshness_hours=(1, 24),
)
def glucose_entries(partition_date: str):
    &quot;&quot;&quot;
    Ingest Nightscout glucose entries with automatic validation.

    The decorator validates data against RawGlucoseEntries schema:
    - Checks all field types and constraints
    - Validates glucose ranges (1-1000 for raw)
    - Ensures unique entry IDs
    - Logs validation failures with details
    &quot;&quot;&quot;
    start_time_iso = f&quot;{partition_date}T00:00:00.000Z&quot;
    end_time_iso = f&quot;{partition_date}T23:59:59.999Z&quot;

    source = rest_api(
        client={&quot;base_url&quot;: &quot;https://gwp-diabetes.fly.dev/api/v1&quot;},
        resources=[
            {
                &quot;name&quot;: &quot;entries&quot;,
                &quot;endpoint&quot;: {
                    &quot;path&quot;: &quot;entries.json&quot;,
                    &quot;params&quot;: {
                        &quot;count&quot;: 10000,
                        &quot;find[dateString][$gte]&quot;: start_time_iso,
                        &quot;find[dateString][$lt]&quot;: end_time_iso,
                    },
                },
            }
        ],
    )

    return source
</code></pre>
<h3 id="detailed-error-messages">Detailed Error Messages</h3>
<p>When validation fails, Pandera provides actionable feedback:</p>
<pre><code>SchemaError: Column 'sgv' has an out-of-range value:

  row_num  sgv
       42  -50   ← Glucose -50? Impossible

  Check failed: lambda x: (x &gt;= 20) &amp; (x &lt;= 600)
  Glucose must be 20-600 mg/dL

Failure counts:
  Total: 3 failures
  Unique values failing: 1
</code></pre>
<p>This helps you:</p>
<ul>
<li>Identify exact problematic rows</li>
<li>Understand which rule failed</li>
<li>Decide: drop, fix, or investigate</li>
</ul>
<h2 id="layer-2-dbt-tests-transformations">Layer 2: dbt Tests (Transformations)</h2>
<p>After ingestion, dbt tests validate business logic during transformations.</p>
<h3 id="schema-tests-yaml-based">Schema Tests (YAML-based)</h3>
<pre><code class="language-yaml"># workflows/transforms/dbt/models/bronze/stg_glucose_entries.yml
version: 2

models:
  - name: stg_glucose_entries
    description: Staged glucose entries with basic cleaning

    columns:
      - name: entry_id
        description: Unique identifier
        tests:
          - unique
          - not_null

      - name: glucose_mg_dl
        description: Glucose in mg/dL
        tests:
          - not_null
          - dbt_expectations.expect_column_values_to_be_between:
              min_value: 20
              max_value: 600
              strictly: false
          - dbt_expectations.expect_column_values_to_match_regex:
              regex: &quot;^\\d+$&quot;

      - name: timestamp_iso
        description: ISO 8601 timestamp
        tests:
          - not_null
          - dbt_utils.expression_is_true:
              expression: &quot;timestamp_iso ~ '^[0-9]{4}-[0-9]{2}-[0-9]{2}T'&quot;

      - name: device_type
        description: Device type (enum)
        tests:
          - not_null
          - accepted_values:
              values: [&quot;dexcom&quot;, &quot;freestyle&quot;, &quot;medtronic&quot;]
</code></pre>
<h3 id="custom-tests-sql">Custom Tests (SQL)</h3>
<pre><code class="language-sql">-- workflows/transforms/dbt/tests/no_duplicate_readings.sql
-- Test: Ensure no duplicate readings within 5 minutes

SELECT
  device_type,
  COUNT(*) as reading_count,
  MIN(timestamp_iso) as earliest,
  MAX(timestamp_iso) as latest
FROM {{ ref('stg_glucose_entries') }}
GROUP BY
  device_type,
  DATE_TRUNC('5 minutes', timestamp_iso)
HAVING COUNT(*) &gt; 1
</code></pre>
<p>If this query returns rows, the test fails (duplicates found).</p>
<h3 id="running-dbt-tests">Running dbt Tests</h3>
<pre><code class="language-bash"># Test all transformations
dbt test --select stg_glucose_entries

# Test specific column
dbt test --select stg_glucose_entries.unique:entry_id

# Show detailed failure output
dbt test --select stg_glucose_entries --debug
</code></pre>
<h2 id="layer-3-dagster-asset-checks-runtime">Layer 3: Dagster Asset Checks (Runtime)</h2>
<p>After orchestration, Dagster asset checks monitor data quality in production. Phlo provides <strong>two approaches</strong>: the declarative <code>@phlo_quality</code> decorator and traditional <code>@asset_check</code> for custom logic.</p>
<h3 id="approach-1-phlo_quality-decorator-declarative">Approach 1: @phlo_quality Decorator (Declarative)</h3>
<p>For common checks (null, range, freshness), use the <code>@phlo_quality</code> decorator to reduce boilerplate by 70-80%:</p>
<pre><code class="language-python"># File: phlo-examples/nightscout/workflows/quality/nightscout.py

import phlo
from phlo_quality import NullCheck, RangeCheck, FreshnessCheck

@phlo_quality(
    table=&quot;silver.fct_glucose_readings&quot;,
    checks=[
        NullCheck(columns=[&quot;entry_id&quot;, &quot;glucose_mg_dl&quot;, &quot;reading_timestamp&quot;]),
        RangeCheck(column=&quot;glucose_mg_dl&quot;, min_value=20, max_value=600),
        RangeCheck(column=&quot;hour_of_day&quot;, min_value=0, max_value=23),
        FreshnessCheck(column=&quot;reading_timestamp&quot;, max_age_hours=24),
    ],
    group=&quot;nightscout&quot;,
    blocking=True,
)
def glucose_readings_quality():
    &quot;&quot;&quot;Declarative quality checks for glucose readings using @phlo_quality.&quot;&quot;&quot;
    pass


@phlo_quality(
    table=&quot;gold.fct_daily_glucose_metrics&quot;,
    checks=[
        NullCheck(columns=[&quot;reading_date&quot;, &quot;reading_count&quot;, &quot;avg_glucose_mg_dl&quot;]),
        RangeCheck(column=&quot;avg_glucose_mg_dl&quot;, min_value=20, max_value=600),
        RangeCheck(column=&quot;time_in_range_pct&quot;, min_value=0, max_value=100),
    ],
    group=&quot;nightscout&quot;,
    blocking=True,
)
def daily_metrics_quality():
    &quot;&quot;&quot;Declarative quality checks for daily glucose metrics.&quot;&quot;&quot;
    pass
</code></pre>
<h3 id="approach-2-traditional-asset_check-custom-logic">Approach 2: Traditional @asset_check (Custom Logic)</h3>
<p>For complex validation with Pandera schemas or custom business logic:</p>
<pre><code class="language-python"># File: phlo-examples/nightscout/workflows/quality/nightscout.py

from dagster import AssetCheckResult, AssetKey, asset_check
from phlo_trino.resource import TrinoResource
from workflows.schemas.nightscout import FactGlucoseReadings
import pandera.errors


@asset_check(
    name=&quot;nightscout_glucose_quality&quot;,
    asset=AssetKey([&quot;fct_glucose_readings&quot;]),
    blocking=True,
    description=&quot;Validate processed Nightscout glucose data using Pandera schema validation.&quot;,
)
def nightscout_glucose_quality_check(context, trino: TrinoResource) -&gt; AssetCheckResult:
    &quot;&quot;&quot;
    Quality check using Pandera for type-safe schema validation.

    Validates glucose readings against the FactGlucoseReadings schema,
    checking data types, ranges, and business rules directly against Iceberg via Trino.
    &quot;&quot;&quot;
    query = &quot;&quot;&quot;
    SELECT
        entry_id,
        glucose_mg_dl,
        reading_timestamp,
        direction,
        hour_of_day,
        day_of_week,
        glucose_category,
        is_in_range
    FROM iceberg_dev.silver.fct_glucose_readings
    &quot;&quot;&quot;

    partition_key = getattr(context, &quot;partition_key&quot;, None)
    if partition_key:
        query = f&quot;{query}\nWHERE DATE(reading_timestamp) = DATE '{partition_key}'&quot;
        context.log.info(f&quot;Validating partition: {partition_key}&quot;)

    try:
        with trino.cursor(schema=&quot;silver&quot;) as cursor:
            cursor.execute(query)
            rows = cursor.fetchall()
            columns = [desc[0] for desc in cursor.description]

        fact_df = pd.DataFrame(rows, columns=columns)

        # Type conversions
        fact_df[&quot;glucose_mg_dl&quot;] = fact_df[&quot;glucose_mg_dl&quot;].astype(&quot;int64&quot;)
        fact_df[&quot;hour_of_day&quot;] = fact_df[&quot;hour_of_day&quot;].astype(&quot;int64&quot;)
        fact_df[&quot;day_of_week&quot;] = fact_df[&quot;day_of_week&quot;].astype(&quot;int64&quot;)
        fact_df[&quot;is_in_range&quot;] = fact_df[&quot;is_in_range&quot;].astype(&quot;int64&quot;)
        fact_df[&quot;reading_timestamp&quot;] = pd.to_datetime(fact_df[&quot;reading_timestamp&quot;])

        context.log.info(f&quot;Loaded {len(fact_df)} rows for validation&quot;)

    except Exception as exc:
        context.log.error(f&quot;Failed to load data from Trino: {exc}&quot;)
        return AssetCheckResult(
            passed=False,
            metadata={
                &quot;reason&quot;: &quot;trino_query_failed&quot;,
                &quot;error&quot;: str(exc),
            },
        )

    if fact_df.empty:
        return AssetCheckResult(
            passed=True,
            metadata={
                &quot;rows_validated&quot;: 0,
                &quot;note&quot;: &quot;No data available for selected partition&quot;,
            },
        )

    # Validate with Pandera schema
    context.log.info(&quot;Validating data with Pandera schema...&quot;)
    try:
        FactGlucoseReadings.validate(fact_df, lazy=True)
        context.log.info(&quot;All validation checks passed!&quot;)

        return AssetCheckResult(
            passed=True,
            metadata={
                &quot;rows_validated&quot;: len(fact_df),
                &quot;columns_validated&quot;: len(fact_df.columns),
            },
        )

    except pandera.errors.SchemaErrors as err:
        failure_cases = err.failure_cases
        context.log.warning(f&quot;Validation failed with {len(failure_cases)} check failures&quot;)

        return AssetCheckResult(
            passed=False,
            metadata={
                &quot;rows_evaluated&quot;: len(fact_df),
                &quot;failed_checks&quot;: len(failure_cases),
                &quot;failures_by_column&quot;: failure_cases.groupby(&quot;column&quot;).size().to_dict(),
                &quot;sample_failures&quot;: failure_cases.head(10).to_dict(orient=&quot;records&quot;),
            },
        )
</code></pre>
<h3 id="viewing-check-results">Viewing Check Results</h3>
<p>In Dagster UI:</p>
<pre><code>Asset: fct_glucose_readings
├─ ✓ glucose_range_check (PASSED)
│  └─ valid_count: 4,987 / 5,000
│  └─ percentage_valid: 99.74%
├─ ✓ glucose_freshness_check (PASSED)
│  └─ latest_reading_hours_ago: 0.15
├─ ✗ glucose_statistical_bounds_check (FAILED)
│  └─ outlier_count: 3
│  └─ bounds: [45.2, 215.8]
│  └─ Action: Investigate readings outside [45, 215]
</code></pre>
<h2 id="comparing-both-approaches">Comparing Both Approaches</h2>
<p>Both approaches are used in the actual Phlo implementation and serve different purposes:</p>
<h3 id="phlo_quality-declarative-10-lines">@phlo_quality: Declarative (10 lines)</h3>
<p>Best for standard checks - reduces boilerplate by 70-80%:</p>
<pre><code class="language-python"># File: phlo-examples/nightscout/workflows/quality/nightscout.py

import phlo
from phlo_quality import NullCheck, RangeCheck, FreshnessCheck

@phlo_quality(
    table=&quot;silver.fct_glucose_readings&quot;,
    checks=[
        NullCheck(columns=[&quot;entry_id&quot;, &quot;glucose_mg_dl&quot;, &quot;reading_timestamp&quot;]),
        RangeCheck(column=&quot;glucose_mg_dl&quot;, min_value=20, max_value=600),
        RangeCheck(column=&quot;hour_of_day&quot;, min_value=0, max_value=23),
        FreshnessCheck(column=&quot;reading_timestamp&quot;, max_age_hours=24),
    ],
    group=&quot;nightscout&quot;,
    blocking=True,
)
def glucose_readings_quality():
    &quot;&quot;&quot;Declarative quality checks for glucose readings.&quot;&quot;&quot;
    pass
</code></pre>
<h3 id="traditional-asset_check-custom-logic-80-lines">Traditional @asset_check: Custom Logic (80+ lines)</h3>
<p>Best for complex validation with Pandera schemas or custom business logic:</p>
<pre><code class="language-python"># File: phlo-examples/nightscout/workflows/quality/nightscout.py

@asset_check(
    name=&quot;nightscout_glucose_quality&quot;,
    asset=AssetKey([&quot;fct_glucose_readings&quot;]),
    blocking=True,
)
def nightscout_glucose_quality_check(context, trino: TrinoResource) -&gt; AssetCheckResult:
    &quot;&quot;&quot;Full Pandera schema validation with custom error handling.&quot;&quot;&quot;

    # Query data from Trino
    query = &quot;&quot;&quot;SELECT entry_id, glucose_mg_dl, ... FROM iceberg_dev.silver.fct_glucose_readings&quot;&quot;&quot;
    with trino.cursor() as cursor:
        cursor.execute(query)
        rows = cursor.fetchall()

    fact_df = pd.DataFrame(rows, columns=columns)

    # Validate with Pandera schema
    try:
        FactGlucoseReadings.validate(fact_df, lazy=True)
        return AssetCheckResult(passed=True, metadata={...})
    except pandera.errors.SchemaErrors as err:
        return AssetCheckResult(passed=False, metadata={...})
</code></pre>
<p><strong>Both approaches are valid</strong> - use <code>@phlo_quality</code> for common checks, <code>@asset_check</code> for complex logic.</p>
<h3 id="available-check-types">Available Check Types</h3>
<table>
<thead>
<tr>
<th>Check Type</th>
<th>Purpose</th>
<th>Parameters</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>NullCheck</code></td>
<td>Verify no nulls</td>
<td><code>columns</code>, <code>tolerance</code> (% allowed)</td>
</tr>
<tr>
<td><code>RangeCheck</code></td>
<td>Verify numeric bounds</td>
<td><code>column</code>, <code>min_value</code>, <code>max_value</code></td>
</tr>
<tr>
<td><code>FreshnessCheck</code></td>
<td>Verify data recency</td>
<td><code>column</code>, <code>max_age_hours</code></td>
</tr>
<tr>
<td><code>UniqueCheck</code></td>
<td>Verify uniqueness</td>
<td><code>columns</code> (can be composite)</td>
</tr>
<tr>
<td><code>CountCheck</code></td>
<td>Verify row count</td>
<td><code>min_count</code>, <code>max_count</code></td>
</tr>
<tr>
<td><code>SchemaCheck</code></td>
<td>Validate against Pandera</td>
<td><code>schema</code> (DataFrameModel class)</td>
</tr>
<tr>
<td><code>CustomSQLCheck</code></td>
<td>Run arbitrary SQL</td>
<td><code>sql</code>, <code>expected_result</code></td>
</tr>
</tbody>
</table>
<h3 id="check-parameters-in-detail">Check Parameters in Detail</h3>
<p><strong>NullCheck with tolerance:</strong></p>
<pre><code class="language-python"># Strict: no nulls allowed
NullCheck(columns=[&quot;sgv&quot;, &quot;timestamp&quot;])

# Lenient: allow up to 1% nulls
NullCheck(columns=[&quot;device&quot;], tolerance=0.01)
</code></pre>
<p><strong>RangeCheck:</strong></p>
<pre><code class="language-python"># Both bounds
RangeCheck(column=&quot;sgv&quot;, min_value=20, max_value=600)

# Only lower bound
RangeCheck(column=&quot;price&quot;, min_value=0)

# Only upper bound
RangeCheck(column=&quot;percentage&quot;, max_value=100)
</code></pre>
<p><strong>FreshnessCheck:</strong></p>
<pre><code class="language-python"># Data must be less than 2 hours old
FreshnessCheck(column=&quot;timestamp&quot;, max_age_hours=2)

# Different column name
FreshnessCheck(column=&quot;created_at&quot;, max_age_hours=24)
</code></pre>
<p><strong>UniqueCheck:</strong></p>
<pre><code class="language-python"># Single column unique
UniqueCheck(columns=[&quot;id&quot;])

# Composite unique (combination must be unique)
UniqueCheck(columns=[&quot;user_id&quot;, &quot;timestamp&quot;])
</code></pre>
<p><strong>CustomSQLCheck for complex rules:</strong></p>
<pre><code class="language-python">CustomSQLCheck(
    name=&quot;business_hours_only&quot;,
    sql=&quot;&quot;&quot;
        SELECT COUNT(*) as violations
        FROM {table}
        WHERE HOUR(timestamp) &lt; 6 OR HOUR(timestamp) &gt; 22
    &quot;&quot;&quot;,
    expected_result=0,  # Zero violations expected
)
</code></pre>
<h3 id="decorator-parameters">Decorator Parameters</h3>
<pre><code class="language-python">@phlo_quality(
    table=&quot;silver.fct_glucose_readings&quot;,  # Fully qualified table name
    checks=[...],                          # List of check instances
    group=&quot;glucose&quot;,                       # Asset group (optional)
    blocking=True,                         # Fail downstream if check fails
    warn_threshold=0.1,                    # Warn if &gt;10% of checks fail
    backend=&quot;trino&quot;,                       # Query backend: &quot;trino&quot; or &quot;duckdb&quot;
)
</code></pre>
<p><strong>blocking parameter:</strong></p>
<ul>
<li><code>blocking=True</code> (default): Failed checks prevent downstream assets from running</li>
<li><code>blocking=False</code>: Failed checks log warnings but don't block execution</li>
</ul>
<p><strong>warn_threshold:</strong></p>
<ul>
<li>Set to <code>0.0</code> for strict mode (any failure = warning)</li>
<li>Set to <code>0.1</code> to allow 10% of checks to fail before warning</li>
</ul>
<h3 id="combining-with-pandera-schemas">Combining with Pandera Schemas</h3>
<p>For complex validation, combine the decorator with Pandera:</p>
<pre><code class="language-python">from phlo_quality import SchemaCheck
from workflows.schemas.glucose import FactGlucoseReadings

@phlo_quality(
    table=&quot;silver.fct_glucose_readings&quot;,
    checks=[
        # Use Pandera for full schema validation
        SchemaCheck(schema=FactGlucoseReadings),

        # Plus additional runtime checks
        FreshnessCheck(column=&quot;timestamp&quot;, max_age_hours=2),
    ],
)
def glucose_comprehensive_quality():
    pass
</code></pre>
<h3 id="when-to-use-each-approach">When to Use Each Approach</h3>
<table>
<thead>
<tr>
<th>Scenario</th>
<th>Recommended Approach</th>
<th>Example</th>
</tr>
</thead>
<tbody>
<tr>
<td>Standard null/range/freshness checks</td>
<td><code>@phlo_quality</code> decorator</td>
<td><code>NullCheck</code>, <code>RangeCheck</code>, <code>FreshnessCheck</code></td>
</tr>
<tr>
<td>Full Pandera schema validation</td>
<td>Traditional <code>@asset_check</code></td>
<td><code>FactGlucoseReadings.validate()</code></td>
</tr>
<tr>
<td>Complex business logic</td>
<td>Traditional <code>@asset_check</code></td>
<td>Custom distribution checks</td>
</tr>
<tr>
<td>Statistical analysis</td>
<td>Traditional <code>@asset_check</code></td>
<td>Outlier detection</td>
</tr>
<tr>
<td>Multiple simple checks</td>
<td><code>@phlo_quality</code> decorator</td>
<td>Combine <code>NullCheck</code> + <code>RangeCheck</code></td>
</tr>
<tr>
<td>Custom error handling</td>
<td>Traditional <code>@asset_check</code></td>
<td>Detailed failure reporting</td>
</tr>
</tbody>
</table>
<p><strong>Real-world usage in phlo-examples/nightscout</strong>:</p>
<ul>
<li><code>@phlo_quality</code>: <code>glucose_readings_quality()</code>, <code>daily_metrics_quality()</code> - standard checks</li>
<li><code>@asset_check</code>: <code>nightscout_glucose_quality_check()</code> - full Pandera validation with custom error handling</li>
</ul>
<p>Both approaches are valid and complement each other. The decorator handles common cases efficiently, while traditional checks provide full control for complex scenarios.</p>
<h2 id="validation-at-each-layer">Validation at Each Layer</h2>
<h3 id="why-three-layers">Why Three Layers?</h3>
<pre><code>┌─────────────────────────────────────┐
│ Layer 1: Pandera (Ingestion)        │
│ ✓ Type correctness                  │
│ ✓ Basic constraints (range, enum)   │
│ ✓ Prevent bad data entering system  │
└─────────────────────────────────────┘
          ↓ (only clean data passes)
┌─────────────────────────────────────┐
│ Layer 2: dbt Tests (Transformation) │
│ ✓ Business logic rules              │
│ ✓ Cross-table consistency           │
│ ✓ Catch issues during transform     │
└─────────────────────────────────────┘
          ↓ (only valid transforms apply)
┌─────────────────────────────────────┐
│ Layer 3: Asset Checks (Runtime)     │
│ ✓ Production data quality           │
│ ✓ Anomaly detection                 │
│ ✓ Freshness monitoring              │
└─────────────────────────────────────┘
</code></pre>
<p>Each layer catches different issues:</p>
<ul>
<li><strong>Pandera</strong>: Bad API responses</li>
<li><strong>dbt</strong>: Broken business logic</li>
<li><strong>Asset Checks</strong>: Unexpected data patterns</li>
</ul>
<h2 id="practical-example-catching-a-bug">Practical Example: Catching a Bug</h2>
<pre><code>Tuesday 3am: Nightscout API starts returning SGV = NULL

[1] Pandera catches it:
    ✗ Column 'sgv' has null values (not nullable)
    → Ingestion stops, alert sent
    → Manual investigation before data corrupts

Without Layer 1:
    [2] dbt Test would catch it:
        ✗ not_null check fails
        → Build fails
        → Data already written to staging

    Without Layer 2:
        [3] Asset Check catches it:
            ✗ All values are NULL
            → Dashboard shows &quot;N/A&quot;
            → Users question data validity
</code></pre>
<h2 id="configuring-validation-strictness">Configuring Validation Strictness</h2>
<pre><code class="language-python"># phlo/config.py
from pydantic import BaseSettings

class DataQualityConfig(BaseSettings):
    # Validation behavior
    pandera_strict: bool = True  # Fail on any schema error
    allow_null_in_required: bool = False

    # Thresholds for warnings
    max_invalid_percentage: float = 1.0  # Warn if &gt;1% invalid
    freshness_threshold_hours: float = 2.0

    # Anomaly detection
    enable_statistical_checks: bool = True
    outlier_std_devs: float = 3.0

    class Config:
        env_file = (&quot;.phlo/.env&quot;, &quot;.phlo/.env.local&quot;)

config = DataQualityConfig()
</code></pre>
<p>Use in code:</p>
<pre><code class="language-python"># Ingestion: strict
if config.pandera_strict:
    validated_df = glucose_entries_schema.validate(data)
else:
    # Lenient: log but continue
    try:
        validated_df = glucose_entries_schema.validate(data)
    except pa.errors.SchemaError as e:
        context.log.warning(f&quot;Schema validation failed: {e}&quot;)
        validated_df = data  # Proceed anyway
</code></pre>
<h2 id="monitoring-dashboard">Monitoring Dashboard</h2>
<p>Create a Superset dashboard for data quality:</p>
<pre><code class="language-sql">-- Query: Validation failures by day
SELECT
  DATE(check_timestamp) as date,
  check_name,
  COUNT(*) as failure_count,
  COUNT(*) * 100.0 / SUM(COUNT(*)) OVER (PARTITION BY DATE(check_timestamp)) as pct
FROM data_quality_logs
WHERE status = 'FAILED'
GROUP BY 1, 2
ORDER BY 1 DESC, 3 DESC;

-- Query: Freshness by asset
SELECT
  asset_name,
  MAX(data_date) as latest_data,
  NOW() - MAX(data_date) as hours_stale,
  CASE
    WHEN NOW() - MAX(data_date) &lt; '2 hours'::interval THEN '✓ Fresh'
    WHEN NOW() - MAX(data_date) &lt; '24 hours'::interval THEN '⚠ Stale'
    ELSE '✗ Very Stale'
  END as freshness_status
FROM asset_metadata
GROUP BY 1
ORDER BY 3 DESC;
</code></pre>
<h2 id="summary">Summary</h2>
<p>Phlo uses <strong>three-layer validation</strong>:</p>
<ol>
<li><strong>Pandera</strong> (ingestion): Type and constraint checking</li>
<li><strong>dbt</strong> (transformation): Business logic and consistency</li>
<li><strong>Dagster</strong> (runtime): Production monitoring and anomaly detection</li>
</ol>
<p>This ensures:</p>
<ul>
<li>Bad data never enters the system</li>
<li>Transforms execute correctly</li>
<li>Production issues are caught quickly</li>
</ul>
<p><strong>Next</strong>: <a href="../10-metadata-governance/">Part 10: Metadata and Governance with OpenMetadata</a></p>
<p>See you there!</p>












                
              </article>
            </div>
          
          
  <script>var tabs=__md_get("__tabs");if(Array.isArray(tabs))e:for(var set of document.querySelectorAll(".tabbed-set")){var labels=set.querySelector(".tabbed-labels");for(var tab of tabs)for(var label of labels.getElementsByTagName("label"))if(label.innerText.trim()===tab){var input=document.getElementById(label.htmlFor);input.checked=!0;continue e}}</script>

<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    
      
      
      <script id="__config" type="application/json">{"annotate": null, "base": "../..", "features": ["navigation.instant", "navigation.tracking", "navigation.expand", "navigation.prune", "navigation.indexes", "content.tabs.link", "content.code.annotation", "content.code.copy", "content.code.select", "search.suggest", "search.highlight", "search.share"], "search": "../../assets/javascripts/workers/search.2c215733.min.js", "tags": null, "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": null}</script>
    
    
      <script src="../../assets/javascripts/bundle.79ae519e.min.js"></script>
      
    
  </body>
</html>